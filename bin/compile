#!/bin/sh

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

APT_CACHE_DIR="$CACHE_DIR/apt/cache"
APT_STATE_DIR="$CACHE_DIR/apt/state"

APT_OPTIONS="-o debug::nolocking=true -o dir::cache=$APT_CACHE_DIR -o dir::state=$APT_STATE_DIR"

indent() {
  sed -u 's/^/       /'
}

echo "-----> Initialize docs"

# if docs Gemfile is empty abort
if [ ! -s $BUILD_DIR/docs/Gemfile ]; then
  echo "docs Gemfile is empty" | indent
  exit 1
else
  echo "Install nodejs" | indent

  rm -rf $APT_CACHE_DIR
  mkdir -p "$APT_CACHE_DIR/archives/partial"
  mkdir -p "$APT_STATE_DIR/lists/partial"

  apt-get $APT_OPTIONS update | indent
  apt-get $APT_OPTIONS install --allow-downgrades --allow-remove-essential --allow-change-held-packages -y nodejs | indent

  echo "Remove docs BUNDLED WITH from Gemfile.lock" | indent
  sed -i -r ':begin;$!N;s/(BUNDLED WITH)\n.+//;tbegin;P;D' /app/docs/Gemfile.lock

  echo "Install docs dependencies" | indent
  bundle install --path /app/vendor/bundle --binstubs /app/vendor/bundle/bin --gemfile=/app/docs/Gemfile -j4
fi
